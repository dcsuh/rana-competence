---
title: "workshop"
author: "Daniel Suh"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---


```{r, message = F}
library(here)

source(here("base","src.R"))

library(reshape2)
```


```{r, message = F}
data <- read_csv(here("data/weighted_prev_competence_111220.csv"))
tree <- ape::read.nexus(here("data/raw_data/asup_just_tree.txt"))
names <- read_csv(here("data/raw_data/species_names_ids.csv"))
```





## Variation in competence for each species

### comparing ranked means with and without log-transformation of raw data

```{r}
vl <- readRDS(here("processed_data","vl.rds"))

supp1_raw <- vl %>% arrange(mean) %>% 
  mutate(abb_name = factor(abb_name, levels = abb_name)) %>% 
  ggplot(.,aes(x=abb_name,y=mean)) +
  geom_point() + 
  xlab("Species") + ylab("Viral Load") + 
  geom_linerange(aes(ymin=mean-se,ymax=mean+se)) +
  geom_hline(yintercept = 1) + 
  labs(title = "Viral Loads") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_y_continuous(breaks=seq(0,6,1))

supp1_log10 <- vl %>% arrange(mean) %>% 
  mutate(abb_name = factor(abb_name, levels = abb_name)) %>% 
  ggplot(.,aes(x=abb_name,y=log1p_mean)) +
  geom_point() + 
  xlab("Species") + ylab("log1p(Viral Load)") + 
  geom_linerange(aes(ymin=log1p_mean-log1p_se,ymax=log1p_mean+log1p_se)) +
  geom_hline(yintercept = 1) + 
  labs(title = "Viral Loads") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_y_continuous(breaks=seq(0,6,1))

supp1_raw
supp1_log10
```


```{r}
incidence <- data %>% group_by(WetAltID, Month.1) %>% summarize(incidence = sum(RV.Status))

incidence %>% ggplot(.,aes(x=Month.1, y=incidence)) + geom_col() + facet_grid(vars(WetAltID))
incidence %>% ggplot(.,aes(x=Month.1, y=incidence, group = 1)) + geom_point() + geom_line() + facet_wrap(~WetAltID, nrow = 5, ncol = 4)
```


```{r}
comm_data <- readRDS(here("processed_data","comm_data.rds"))
comm_data %>% ungroup() %>% ggplot(.,aes(x=Month.1, y=Prevalence, group = 1)) + geom_point() + geom_line() + facet_wrap(~WetAltID, nrow = 5, ncol = 4)
```

```{r}
comm_data %>% ggplot(.,aes(x=size)) + geom_histogram() + labs(title = "Untransformed abundance")
comm_data %>% ggplot(.,aes(x=log10(size))) + geom_histogram() + labs(title = "log10-transformed abundance")
comm_data %>% ggplot(.,aes(x=cc)) + geom_histogram() + labs(title = "Untransformed cc")
comm_data %>% ggplot(.,aes(x=log10(cc))) + geom_histogram() + labs(title = "log10-transformed cc")
comm_data %>% ggplot(.,aes(x=MeanWaterTempPredC)) + geom_histogram() + labs(title = "Mean Water Temp")
```


Standard deviations from the mean
This chunk attempts to characterize each wetland in terms of how exceptional they are compared to other wetlands in terms of abundance, cc, and temp
The idea is that if certain wetlands tend to be highly abundant with high community competence and lower temperatures, then we might expect them to be a perfect environment for ranavirus to thrive. 
```{r}
comm_data <- readRDS(here("processed_data","comm_data.rds"))
comm_data %>% mutate(mean = mean(size), sd = sd(size), var = mean(size)-size, size = size)
comm_effect <- comm_data %>% filter(MeanWaterTempPredC>0) %>% mutate(size_sds = (mean(size)-size)/sd(size),
                                    cc_sds = (mean(cc)-cc)/sd(cc),
                                    temp_sds = ((mean(MeanWaterTempPredC)-MeanWaterTempPredC)/sd(MeanWaterTempPredC))*-1) #multiply by -1 to make it opposite because

effect_summ <- comm_effect %>% group_by(WetAltID) %>% summarize(size_over = sum(size_sds>0),
                                                                size_sum = sum(size_sds),
                                                                cc_over = sum(cc_sds>0),
                                                                cc_sum = sum(cc_sds),
                                                                temp_over = sum(temp_sds>0),
                                                                temp_sum = sum(temp_sds))
```


