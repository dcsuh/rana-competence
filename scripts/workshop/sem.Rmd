---
title: "sem"
output: html_document
date: "2022-12-06"
---

```{r, message = F}
library(here)

library(tidyverse)
library(magrittr)
library(piecewiseSEM)
library(nlme)
library(lmerTest)
library(mgcv)
library(dagitty)

comm_data <- readRDS(here("processed_data","comm_data.rds"))
```


```{r}
prev_mod <- dagitty("dag{
  temp -> cc
  temp -> size
  cc -> prev
  size -> prev
  temp -> prev
             }")

plot(graphLayout(prev_mod))

```

histograms
```{r}
comm_data %>% ggplot(.,aes(x=MeanWaterTempPredC)) + geom_histogram()
comm_data %>% ggplot(.,aes(x=size)) + geom_histogram()
comm_data %>% ggplot(.,aes(x=log10(size))) + geom_histogram()
comm_data %>% ggplot(.,aes(x=cc)) + geom_histogram()
comm_data %>% ggplot(.,aes(x=log10(cc))) + geom_histogram()
comm_data %>% ggplot(.,aes(x=Prevalence)) + geom_histogram()
```
plots
```{r}
comm_data %>% ggplot(.,aes(x=MeanWaterTempPredC, y = log10(cc))) + geom_point() + geom_smooth(method = "lm")
comm_data %>% ggplot(.,aes(x=MeanWaterTempPredC, y = log10(size))) + geom_point() + geom_smooth(method = "lm")
comm_data %>% ggplot(.,aes(x=MeanWaterTempPredC, y = Prevalence)) + geom_point() + geom_smooth(method = "lm")
comm_data %>% ggplot(.,aes(x=log10(cc), y = Prevalence)) + geom_point() + geom_smooth(method = "lm")
comm_data %>% ggplot(.,aes(x=log10(size), y = Prevalence)) + geom_point() + geom_smooth(method = "lm")
```




cc ~ mean water temp; size ~ mean water temp; prevalence ~ cc + size + mean water temp
```{r}
cc_temp <- gam(log10(cc) ~ s(MeanWaterTempPredC), family = gaussian, data = comm_data)
size_temp <- gam(log10(size) ~ s(MeanWaterTempPredC), family = gaussian, data = comm_data)
prev_cc <- glm(Prevalence ~ log10(cc) + log10(size), data = comm_data)

sem <- psem(cc_temp, size_temp, prev_cc)
```


```{r}
basisSet(sem)
dSep(sem, conditioning = T)
fisherC(sem)
coefs(sem, intercepts = T)
rsquared(sem)
```


```{r}
summary(sem)
plot(sem)
plot(sem, return = T)
```

Lefcheck example

```{r}
data(shipley)
```

```{r}
dd_lat <-  lme(DD~lat, random = ~1|site/tree, na.action = na.omit, 
    data = shipley)

date_dd <-lme(Date~DD, random = ~1|site/tree, na.action = na.omit, 
    data = shipley)

growth_date <-  lme(Growth~Date, random = ~1|site/tree, na.action = na.omit, 
    data = shipley)

live_growth <-  glmer(Live~Growth+(1|site)+(1|tree), 
    family=binomial(link = "logit"), data = shipley)
```

```{r}
shipley_sem <- psem(dd_lat, date_dd, growth_date, live_growth)
```

```{r}
summary(shipley_sem)
```

